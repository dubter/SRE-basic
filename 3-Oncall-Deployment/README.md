# ‚Ññ3 "–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ Oncall"
## 1 –∑–∞–¥–∞–Ω–∏–µ
–î–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ OnCall –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ minikube.

–ò–∑—É—á–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–µ–º–∏–Ω–∞—Ä–∞. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ README, –ø—Ä–∏–ª–æ–∂–µ–Ω–Ω–æ–π –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∏ –Ω–∏–∂–µ.

–í –∫–∞—á–µ—Å—Ç–≤–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–∏—Ç–µ –≤–∏–¥–µ–æ–∑–∞–ø–∏—Å—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞. –ù–∞ –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—É–Ω–∫—Ç–æ–≤. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å OnCall –≤ –±—Ä–∞—É–∑–µ—Ä–µ –≤ –∫–æ–Ω—Ü–µ –≤–∏–¥–µ–æ.

```sh
export http_proxy=''
export https_proxy=''
export no_proxy='localhost,127.0.0.1,.1,.2,.3::1,.local'
```

1. –í–∫–ª—é—á–∞–µ–º ingress –≤ minikube
```sh
minikube addons enable ingress
```

2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ª–∏ ingress controller
```sh
kubectl get pods -n ingress-nginx
```


```sh
git clone https://github.com/linkedin/oncall.git
cd oncall

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–µ–º–æ–Ω–∞ Docker –≤ Minikube
eval $(minikube docker-env)

docker build -t oncall:latest .

# –ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –í–ú, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–º–µ–Ω–∏—Ç—å Dockerfile –∏ —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–±–æ—Ä–∫–∏:
cp ../docker/Dockerfile Dockerfile

docker build -t oncall:latest --build-arg http_proxy=http://10.128.0.4:3128 --build-arg HTTP_PROXY=http://10.128.0.4:3128 --build-arg https_proxy=http://10.128.0.4:3128 --build-arg HTTPS_PROXY=http://10.128.0.4:3128 .
```

–¥–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å –±—É–¥—É—â–µ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ OnCall –≤ /etc/hosts
```sh
127.0.0.1 oncall.local
```

### 1. –ó–∞–ø—É—Å–∫ MySQL
- statefulset.yaml
- service.yaml
- secret.yaml

–°–æ–∑–¥–∞—ë–º Secret —Å –ø–∞—Ä–æ–ª–µ–º –∫ –ë–î –∏ Headless Service:
```sh
cd mysql
kubectl apply -f secret.yaml
kubectl apply -f service.yaml
```
–ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É MySQL
```sh
kubectl apply -f statefulset.yaml
```
–ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø–æ–¥:
```sh
kubectl get pod
```
```
NAME READY STATUS RESTARTS AGE
mysql-0 1/1 Running 0 10m
```

# 2. –ó–∞–ø—É—Å–∫ OnCall
–°–æ–∑–¥–∞—ë–º ConfigMap —Å –∫–æ–Ω—Ñ–∏–≥–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ Service
```sh
cd oncall
kubectl apply -f config.yaml
kubectl apply -f service.yaml
```
–ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É OnCall
```sh
kubectl apply -f deployment.yaml
```

–ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ –ø–æ–¥—ã
```sh
kubectl get pod
```
```
NAME READY STATUS RESTARTS AGE
mysql-0 1/1 Running 0 10m
oncall-94855d89d-6qggk 1/1 Running 0 10m
oncall-94855d89d-k78xm 1/1 Running 0 10m
```
–°–æ–∑–¥–∞—ë–º Ingress –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–∏—Å—É:
```sh
kubectl apply -f ingress.yaml
```
–ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–Ω –ª–∏ —Ä–µ—Å—É—Ä—Å Ingress
```sh
kubectl get ingress
```
```
NAME CLASS HOSTS ADDRESS PORTS AGE
oncall-ingress nginx oncall.local 192.168.49.2 80 5d2h
```
–î–µ–ª–∞–µ–º ingress –¥–æ—Å—Ç—É–ø–Ω—ã–º –Ω–∞ —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω–µ, —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏ minikube. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ!!!
```
minikube tunnel
```
–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å OnCall –ø–æ –∞–¥—Ä–µ—Å—É `oncall.local`
```sh
curl http://oncall.local
```

## 2 –∑–∞–¥–∞–Ω–∏–µ
–ò–∑—É—á–∏—Ç–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã, –ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–µ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º —Å–µ–º–∏–Ω–∞—Ä–∞.
–ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–Ω–∞—Ä—É—à–µ–Ω–∏–µ best practices, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ —Ç.–¥.) –í—ã –∑–∞–º–µ—Ç–∏–ª–∏?
–û–ø–∏—à–∏—Ç–µ –º–∏–Ω–∏–º—É–º –¥–≤–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Å–ø–æ—Å–æ–±—ã –∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

–ì—Ä–µ—Ö–∏ 12 factor architecture
–û—á–µ–Ω—å –º–Ω–æ–≥–æ —Ö–∞—Ä–¥–∫–æ–¥–∞, –∏ –ø–∞–ø–ª–∞–π–Ω—ã —Å —Ç—Ä–∏–∞–∂–∞–º–∏ AppSec'–æ–≤ —Ç–æ—á–Ω–æ –Ω–µ –ø—Ä–æ–π–¥–µ—Ç.

üìÅ my-sql
–ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω –∑–∞—ç–Ω–∫–æ–∂–µ–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç `MTIzNA==`
–ï—Å–ª–∏ —ç—Ç–æ –¥–æ—Å—Ç—É–ø –∫ stg/prod –±–¥, –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –≤–æ—Ç —Ç–∞–∫;
```sh
echo MTIzNA== | base64 --decode
```
–ü–æ —Ö–æ—Ä–æ—à–µ–º—É –≤ –º—ã –¥–æ–ª–∂–Ω—ã –∑–∞–±–∏—Ä–∞—Ç—å –µ–≥–æ –∏–∑ –í–æ–ª—Ç–∞, –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∞:
```yml
---
apiVersion: v1
kind: Secret
metadata:
  name: vault-mysql-secrets
  namespace: vault-operator
type: Opaque
data:
  MYSQL_ROOT_PASSWORD: $(echo -n s.W4ndAJbuoDMsoLDZyVBG18F2 | base64)
```


üìÅ oncall
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –∑–∞—à–∏—Ç–∞ –ø—Ä—è–º–æ –≤ –æ–±—Ä–∞–∑ ‚Äî —á—Ç–æ-—Ç–æ –º–µ–Ω—è—è–µ–º –ø—Ä–∏–¥–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å –æ–±—Ä–∞–∑.
- –ø–æ —Ö–æ—Ä–æ—à–µ–º—É –¥–æ–ª–∂–∞–Ω–∞ –±—ã—Ç—å –∑–∞—â–∏—Ç–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚Äî –∞ —É –Ω–∞—Å –ø–æ—Ä—Ç—ã –∑–∞—Ö–∞—Ä–∫–æ–∂–µ–Ω—ã, –≤–º–µ—Å—Ç–æ –≤–∞–∏–ª–¥–∫–∞—Ä–¥–æ–≤.
